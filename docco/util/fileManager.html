<!DOCTYPE html>

<html>
<head>
  <title>fileManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="datetime.html">
                datetime.js
              </a>
            
              
              <a class="source" href="device.html">
                device.js
              </a>
            
              
              <a class="source" href="fileManager.html">
                fileManager.js
              </a>
            
              
              <a class="source" href="filename.html">
                filename.js
              </a>
            
              
              <a class="source" href="h.html">
                h.js
              </a>
            
              
              <a class="source" href="misc.html">
                misc.js
              </a>
            
              
              <a class="source" href="object.html">
                object.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>fileManager.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 *
 * FileManager implements methods that interact with the HTML5 API
 *
 * @module fileManager.js
 * @author Kerri Shotts
 * @version 0.4
 * ```
 * Copyright (c) 2013 Kerri Shotts, photoKandy Studios LLC
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this
 * software and associated documentation files (the "Software"), to deal in the Software
 * without restriction, including without limitation the rights to use, copy, modify,
 * merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * The above copyright notice and this permission notice shall be included in all copies
 * or substantial portions of the Software.
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR
 * PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT
 * OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 * ```
 */</span>
<span class="hljs-comment">/*globals define, Q, LocalFileSystem, console, window, navigator, FileReader*/</span>
define( [ <span class="hljs-string">"Q"</span>, <span class="hljs-string">"yasmf/util/object"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( Q, BaseObject )</span> </span>{
<span class="hljs-pi">  "use strict"</span>;
  <span class="hljs-keyword">var</span> IN_YASMF = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> ( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( Q, BaseObject, globalContext )</span> </span>{
    <span class="hljs-comment">/**
     * Defined by Q, actually, but defined here to make type handling nicer
     * @typedef {{}} Promise
     */</span>
    <span class="hljs-keyword">var</span> DEBUG = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">/**
     * Requests a quota from the file system
     * @method _requestQuota
     * @private
     * @param  {*} fileSystemType    PERSISTENT or TEMPORARY
     * @param  {Number} requestedDataSize The quota we're asking for
     * @return {Promise}                   The promise
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requestQuota</span><span class="hljs-params">( fileSystemType, requestedDataSize )</span> </span>{
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestQuota: "</span>, fileSystemType, requestedDataSize ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>attempt to ask for a quota</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> PERSISTENT = ( <span class="hljs-keyword">typeof</span> LocalFileSystem !== <span class="hljs-string">"undefined"</span> ) ? LocalFileSystem.PERSISTENT : <span class="hljs-built_in">window</span>.PERSISTENT,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Chrome has <code>webkitPersistentStorage</code> and <code>navigator.webkitTemporaryStorage</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            storageInfo = fileSystemType === PERSISTENT ? navigator.webkitPersistentStorage : navigator.webkitTemporaryStorage;
          <span class="hljs-keyword">if</span> ( storageInfo ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>now make sure we can request a quota</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( storageInfo.requestQuota ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>request the quota</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              storageInfo.requestQuota( requestedDataSize, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( grantedBytes )</span> </span>{
                <span class="hljs-keyword">if</span> ( DEBUG ) {
                  <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestQuota: quota granted: "</span>, fileSystemType,
                    grantedBytes
                  ].join( <span class="hljs-string">" "</span> ) );
                }
                deferred.resolve( grantedBytes );
              }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
                <span class="hljs-keyword">if</span> ( DEBUG ) {
                  <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestQuota: quota rejected: "</span>, fileSystemType,
                    requestedDataSize, anError
                  ].join( <span class="hljs-string">" "</span> ) );
                }
                deferred.reject( anError );
              } );
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>not everything supports asking for a quota — like Cordova.
Instead, let’s assume we get permission</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> ( DEBUG ) {
                <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestQuota: couldn't request quota -- no requestQuota: "</span>,
                  fileSystemType, requestedDataSize
                ].join( <span class="hljs-string">" "</span> ) );
              }
              deferred.resolve( requestedDataSize );
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> ( DEBUG ) {
              <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestQuota: couldn't request quota -- no storageInfo: "</span>,
                fileSystemType, requestedDataSize
              ].join( <span class="hljs-string">" "</span> ) );
            }
            deferred.resolve( requestedDataSize );
          }
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Request a file system with the requested size (obtained first by getting a quota)
       * @method _requestFileSystem
       * @private
       * @param  {*} fileSystemType    TEMPORARY or PERSISTENT
       * @param  {Number} requestedDataSize The quota
       * @return {Promise}                   The promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requestFileSystem</span><span class="hljs-params">( fileSystemType, requestedDataSize )</span> </span>{
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestFileSystem: "</span>, fileSystemType, requestedDataSize ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>fix issue #2 by chasen where using <code>webkitRequestFileSystem</code> was having problems
on Android 4.2.2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> requestFileSystem = <span class="hljs-built_in">window</span>.requestFileSystem || <span class="hljs-built_in">window</span>.webkitRequestFileSystem;
          requestFileSystem( fileSystemType, requestedDataSize, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theFileSystem )</span> </span>{
            <span class="hljs-keyword">if</span> ( DEBUG ) {
              <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestFileSystem: got a file system"</span>, theFileSystem ].join( <span class="hljs-string">" "</span> ) );
            }
            deferred.resolve( theFileSystem );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            <span class="hljs-keyword">if</span> ( DEBUG ) {
              <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_requestFileSystem: couldn't get a file system"</span>,
                fileSystemType
              ].join( <span class="hljs-string">" "</span> ) );
            }
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Resolves theURI to a fileEntry or directoryEntry, if possible.
       * If `theURL` contains `private` or `localhost` as its first element, it will be removed. If
       * `theURL` does not have a URL scheme, `file://` will be assumed.
       * @method _resolveLocalFileSystemURL
       * @private
       * @param  {String} theURL the path, should start with file://, but if it doesn't we'll add it.
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resolveLocalFileSystemURL</span><span class="hljs-params">( theURL )</span> </span>{
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_resolveLocalFileSystemURL: "</span>, theURL ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>split the parts of the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> parts = theURL.split( <span class="hljs-string">":"</span> ),
            protocol, path;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>can only have two parts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( parts.length &gt; <span class="hljs-number">2</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"The URI is not well-formed; missing protocol: "</span> + theURL );
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>if only one part, we assume <code>file</code> as the protocol</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( parts.length &lt; <span class="hljs-number">2</span> ) {
            protocol = <span class="hljs-string">"file"</span>;
            path = parts[ <span class="hljs-number">0</span> ];
          } <span class="hljs-keyword">else</span> {
            protocol = parts[ <span class="hljs-number">0</span> ];
            path = parts[ <span class="hljs-number">1</span> ];
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>split the path components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> pathComponents = path.split( <span class="hljs-string">"/"</span> ),
            newPathComponents = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>iterate over each component and trim as we go</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          pathComponents.forEach( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( part )</span> </span>{
            part = part.trim();
            <span class="hljs-keyword">if</span> ( part !== <span class="hljs-string">""</span> ) { <span class="hljs-comment">// remove /private if it is the first item in the new array, for iOS sake</span>
              <span class="hljs-keyword">if</span> ( !( ( part === <span class="hljs-string">"private"</span> || part === <span class="hljs-string">"localhost"</span> ) &amp;&amp; newPathComponents.length === <span class="hljs-number">0</span> ) ) {
                newPathComponents.push( part );
              }
            }
          } );</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>rejoin the path components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> theNewURI = newPathComponents.join( <span class="hljs-string">"/"</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>add the protocol</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          theNewURI = protocol + <span class="hljs-string">":///"</span> + theNewURI;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>and resolve the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">window</span>.resolveLocalFileSystemURL( theNewURI, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theEntry )</span> </span>{
            deferred.resolve( theEntry );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * @typedef {{}} DirectoryEntry
       * HTML5 File API Directory Type
       */</span>
      <span class="hljs-comment">/**
       * Returns a directory entry based on the path from the parent using
       * the specified options, if specified. `options` takes the form:
       * ` {create: true/false, exclusive true/false }`
       * @method _getDirectoryEntry
       * @private
       * @param  {DirectoryEntry} parent  The parent that path is relative from (or absolute)
       * @param  {String} path    The relative or absolute path or a {DirectoryEntry}
       * @param  {Object} options The options (that is, create the directory if it doesn't exist, etc.)
       * @return {Promise}         The promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getDirectoryEntry</span><span class="hljs-params">( parent, path, options )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_getDirectoryEntry:"</span>, parent, path, options ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> path === <span class="hljs-string">"object"</span> ) {
            deferred.resolve( path );
          } <span class="hljs-keyword">else</span> {
            parent.getDirectory( path, options || {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
              deferred.resolve( theDirectoryEntry );
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
              deferred.reject( anError );
            } );
          }
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Returns a file entry based on the path from the parent using
       * the specified options. `options` takes the form of `{ create: true/false, exclusive: true/false}`
       * @method getFileEntry
       * @private
       * @param  {DirectoryEntry} parent  The parent that path is relative from (or absolute)
       * @param  {String} path    The relative or absolute path
       * @param  {Object} options The options (that is, create the file if it doesn't exist, etc.)
       * @return {Promise}         The promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getFileEntry</span><span class="hljs-params">( parent, path, options )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_getFileEntry:"</span>, parent, path, options ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> path === <span class="hljs-string">"object"</span> ) {
            deferred.resolve( path );
          } <span class="hljs-keyword">else</span> {
            parent.getFile( path, options || {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theFileEntry )</span> </span>{
              deferred.resolve( theFileEntry );
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
              deferred.reject( anError );
            } );
          }
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * @typedef {{}} FileEntry
       * HTML5 File API File Entry
       */</span>
      <span class="hljs-comment">/**
       * Returns a file object based on the file entry.
       * @method _getFileObject
       * @private
       * @param  {FileEntry} fileEntry The file Entry
       * @return {Promise}           The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getFileObject</span><span class="hljs-params">( fileEntry )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_getFileObject:"</span>, fileEntry ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          fileEntry.file( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theFile )</span> </span>{
            deferred.resolve( theFile );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Reads the file contents from a file object. readAsKind indicates how
       * to read the file ("Text", "DataURL", "BinaryString", "ArrayBuffer").
       * @method _readFileContents
       * @private
       * @param  {File} fileObject File to read
       * @param  {String} readAsKind "Text", "DataURL", "BinaryString", "ArrayBuffer"
       * @return {Promise}            The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_readFileContents</span><span class="hljs-params">( fileObject, readAsKind )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_readFileContents:"</span>, fileObject, readAsKind ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">var</span> fileReader = <span class="hljs-keyword">new</span> FileReader();
          fileReader.onloadend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( e )</span> </span>{
            deferred.resolve( e.target.result );
          };
          fileReader.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          };
          fileReader[ <span class="hljs-string">"readAs"</span> + readAsKind ]( fileObject );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Creates a file writer for the file entry; `fileEntry` must exist
       * @method _createFileWriter
       * @private
       * @param  {FileEntry} fileEntry The file entry to write to
       * @return {Promise}           the Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_createFileWriter</span><span class="hljs-params">( fileEntry )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_createFileWriter:"</span>, fileEntry ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">var</span> fileWriter = fileEntry.createWriter( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theFileWriter )</span> </span>{
            deferred.resolve( theFileWriter );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * @typedef {{}} FileWriter
       * HTML5 File API File Writer Type
       */</span>
      <span class="hljs-comment">/**
       * Write the contents to the fileWriter; `contents` should be a Blob.
       * @method _writeFileContents
       * @private
       * @param  {FileWriter} fileWriter Obtained from _createFileWriter
       * @param  {*} contents   The contents to write
       * @return {Promise}            the Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_writeFileContents</span><span class="hljs-params">( fileWriter, contents )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_writeFileContents:"</span>, fileWriter, contents ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          fileWriter.onwrite = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( e )</span> </span>{
            fileWriter.onwrite = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( e )</span> </span>{
              deferred.resolve( e );
            };
            fileWriter.write( contents );
          };
          fileWriter.onError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          };
          fileWriter.truncate( <span class="hljs-number">0</span> ); <span class="hljs-comment">// clear out the contents, first</span>
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Copy the file to the specified parent directory, with an optional new name
       * @method _copyFile
       * @private
       * @param  {FileEntry} theFileEntry            The file to copy
       * @param  {DirectoryEntry} theParentDirectoryEntry The parent directory to copy the file to
       * @param  {String} theNewName              The new name of the file ( or undefined simply to copy )
       * @return {Promise}                         The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_copyFile</span><span class="hljs-params">( theFileEntry, theParentDirectoryEntry, theNewName )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_copyFile:"</span>, theFileEntry, theParentDirectoryEntry,
            theNewName
          ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          theFileEntry.copyTo( theParentDirectoryEntry, theNewName, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theNewFileEntry )</span> </span>{
            deferred.resolve( theNewFileEntry );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Move the file to the specified parent directory, with an optional new name
       * @method _moveFile
       * @private
       * @param  {FileEntry} theFileEntry            The file to move or rename
       * @param  {DirectoryEntry} theParentDirectoryEntry The parent directory to move the file to (or the same as the file in order to rename)
       * @param  {String} theNewName              The new name of the file ( or undefined simply to move )
       * @return {Promise}                         The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_moveFile</span><span class="hljs-params">( theFileEntry, theParentDirectoryEntry, theNewName )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_moveFile:"</span>, theFileEntry, theParentDirectoryEntry,
            theNewName
          ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          theFileEntry.moveTo( theParentDirectoryEntry, theNewName, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theNewFileEntry )</span> </span>{
            deferred.resolve( theNewFileEntry );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Remove the file from the file system
       * @method _removeFile
       * @private
       * @param  {FileEntry} theFileEntry The file to remove
       * @return {Promise}              The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeFile</span><span class="hljs-params">( theFileEntry )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_removeFile:"</span>, theFileEntry ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          theFileEntry.remove( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">()</span> </span>{
            deferred.resolve();
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Copies a directory to the specified directory, with an optional new name. The directory
       * is copied recursively.
       * @method _copyDirectory
       * @private
       * @param  {DirectoryEntry} theDirectoryEntry       The directory to copy
       * @param  {DirectoryEntry} theParentDirectoryEntry The parent directory to copy the first directory to
       * @param  {String} theNewName              The optional new name for the directory
       * @return {Promise}                         A promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_copyDirectory</span><span class="hljs-params">( theDirectoryEntry, theParentDirectoryEntry, theNewName )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_copyDirectory:"</span>, theDirectoryEntry,
            theParentDirectoryEntry,
            theNewName
          ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          theDirectoryEntry.copyTo( theParentDirectoryEntry, theNewName, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theNewDirectoryEntry )</span> </span>{
            deferred.resolve( theNewDirectoryEntry );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Moves a directory to the specified directory, with an optional new name. The directory
       * is moved recursively.
       * @method _moveDirectory
       * @private
       * @param  {DirectoryEntry} theDirectoryEntry       The directory to move
       * @param  {DirectoryEntry} theParentDirectoryEntry The parent directory to move the first directory to
       * @param  {String} theNewName              The optional new name for the directory
       * @return {Promise}                         A promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_moveDirectory</span><span class="hljs-params">( theDirectoryEntry, theParentDirectoryEntry, theNewName )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_moveDirectory:"</span>, theDirectoryEntry,
            theParentDirectoryEntry,
            theNewName
          ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          theDirectoryEntry.moveTo( theParentDirectoryEntry, theNewName, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theNewDirectoryEntry )</span> </span>{
            deferred.resolve( theNewDirectoryEntry );
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Removes a directory from the file system. If recursively is true, the directory is removed
       * recursively.
       * @method _removeDirectory
       * @private
       * @param  {DirectoryEntry} theDirectoryEntry The directory to remove
       * @param  {Boolean} recursively       If true, remove recursively
       * @return {Promise}                   The Promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeDirectory</span><span class="hljs-params">( theDirectoryEntry, recursively )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_removeDirectory:"</span>, theDirectoryEntry, <span class="hljs-string">"recursively"</span>,
            recursively
          ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> deferred = Q.defer();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> ( !recursively ) {
            theDirectoryEntry.remove( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">()</span> </span>{
              deferred.resolve();
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
              deferred.reject( anError );
            } );
          } <span class="hljs-keyword">else</span> {
            theDirectoryEntry.removeRecursively( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">()</span> </span>{
              deferred.resolve();
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
              deferred.reject( anError );
            } );
          }
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * Reads the contents of a directory
       * @method _readDirectoryContents
       * @private
       * @param  {DirectoryEntry} theDirectoryEntry The directory to list
       * @return {Promise}                   The promise
       */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_readDirectoryContents</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
        <span class="hljs-keyword">if</span> ( DEBUG ) {
          <span class="hljs-built_in">console</span>.log( [ <span class="hljs-string">"_readDirectoryContents:"</span>, theDirectoryEntry ].join( <span class="hljs-string">" "</span> ) );
        }
        <span class="hljs-keyword">var</span> directoryReader = theDirectoryEntry.createReader(),
          entries = [],
          deferred = Q.defer();

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readEntries</span><span class="hljs-params">()</span> </span>{
          directoryReader.readEntries( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span><span class="hljs-params">( theEntries )</span> </span>{
            <span class="hljs-keyword">if</span> ( !theEntries.length ) {
              deferred.resolve( entries );
            } <span class="hljs-keyword">else</span> {
              entries = entries.concat( <span class="hljs-built_in">Array</span>.prototype.slice.call( theEntries || [], <span class="hljs-number">0</span> ) );
              readEntries();
            }
          }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failure</span><span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } );
        }
        <span class="hljs-keyword">try</span> {
          readEntries();
        } <span class="hljs-keyword">catch</span> ( anError ) {
          deferred.reject( anError );
        }
        <span class="hljs-keyword">return</span> deferred.promise;
      }
      <span class="hljs-comment">/**
       * @class FileManager
       */</span>
    <span class="hljs-keyword">var</span> _className = <span class="hljs-string">"UTIL.FileManager"</span>,
      FileManager = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> self,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>determine if we have a <code>BaseObject</code> available or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          hasBaseObject = ( <span class="hljs-keyword">typeof</span> BaseObject !== <span class="hljs-string">"undefined"</span> );
        <span class="hljs-keyword">if</span> ( hasBaseObject ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>if we do, subclass it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self = <span class="hljs-keyword">new</span> BaseObject();
          self.subclass( _className );
          self.registerNotification( <span class="hljs-string">"changedCurrentWorkingDirectory"</span> );
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>otherwise, base off {}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self = {};
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>get the persistent and temporary filesystem constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.PERSISTENT = ( <span class="hljs-keyword">typeof</span> LocalFileSystem !== <span class="hljs-string">"undefined"</span> ) ? LocalFileSystem.PERSISTENT : <span class="hljs-built_in">window</span>.PERSISTENT;
        self.TEMPORARY = ( <span class="hljs-keyword">typeof</span> LocalFileSystem !== <span class="hljs-string">"undefined"</span> ) ? LocalFileSystem.TEMPORARY : <span class="hljs-built_in">window</span>.TEMPORARY;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>determine the various file types we support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.FILETYPE = {
          TEXT: <span class="hljs-string">"Text"</span>,
          DATA_URL: <span class="hljs-string">"DataURL"</span>,
          BINARY: <span class="hljs-string">"BinaryString"</span>,
          ARRAY_BUFFER: <span class="hljs-string">"ArrayBuffer"</span>
        };
        <span class="hljs-comment">/**
         * Returns the value of the global `DEBUG` variable.
         * @method getGlobalDebug
         * @returns {Boolean}
         */</span>
        self.getGlobalDebug = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> DEBUG;
        };
        <span class="hljs-comment">/**
         * Sets the global DEBUG variable. If `true`, debug messages are logged to the console.
         * @method setGlobalDebug
         * @param {Boolean} debug
         */</span>
        self.setGlobalDebug = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( debug )</span> </span>{
          DEBUG = debug;
        };
        <span class="hljs-comment">/**
         * @property globalDebug
         * @type {Boolean} If `true`, logs messages to console as operations occur.
         */</span>
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"globalDebug"</span>, {
          get: self.getGlobalDebug,
          set: self.setGlobalDebug,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * the fileSystemType can either be `self.PERSISTENT` or `self.TEMPORARY`, and is only
         * set during an `init` operation. It cannot be set at any other time.
         * @property fileSystemType
         * @type {FileSystem}
         */</span>
        self._fileSystemType = <span class="hljs-literal">null</span>; <span class="hljs-comment">// can only be changed during INIT</span>
        self.getFileSystemType = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> self._fileSystemType;
        };
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"fileSystemType"</span>, {
          get: self.getFileSystemType,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * The requested quota -- stored for future reference, since we ask for it
         * specifically during an `init` operation. It cannot be changed.
         * @property requestedQuota
         * @type {Number}
         */</span>
        self._requestedQuota = <span class="hljs-number">0</span>; <span class="hljs-comment">// can only be changed during INIT</span>
        self.getRequestedQuota = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> self._requestedQuota;
        };
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"requestedQuota"</span>, {
          get: self.getRequestedQuota,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * The actual quota obtained from the system. It cannot be changed, and is
         * only obtained during `init`. The result does not have to match the
         * `requestedQuota`. If it doesn't match, it may be representative of the
         * actual space available, depending on the platform
         * @property actualQuota
         * @type {Number}
         */</span>
        self._actualQuota = <span class="hljs-number">0</span>;
        self.getActualQuota = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> self._actualQuota;
        };
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"actualQuota"</span>, {
          get: self.getActualQuota,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * @typedef {{}} FileSystem
         * HTML5 File API File System
         */</span>
        <span class="hljs-comment">/**
         * The current filesystem -- either the temporary or persistent one; it can't be changed
         * @property fileSystem
         * @type {FileSystem}
         */</span>
        self._fileSystem = <span class="hljs-literal">null</span>;
        self.getFileSystem = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> self._fileSystem;
        };
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"fileSystem"</span>, {
          get: self.getFileSystem,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * Current Working Directory Entry
         * @property cwd
         * @type {DirectoryEntry}
         */</span>
        self._root = <span class="hljs-literal">null</span>;
        self._cwd = <span class="hljs-literal">null</span>;
        self.getCurrentWorkingDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> self._cwd;
        };
        self.setCurrentWorkingDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theCWD )</span> </span>{
          self._cwd = theCWD;
          <span class="hljs-keyword">if</span> ( hasBaseObject ) {
            self.notify( <span class="hljs-string">"changedCurrentWorkingDirectory"</span> );
          }
        };
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"cwd"</span>, {
          get: self.getCurrentWorkingDirectory,
          set: self.setCurrentWorkingDirectory,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-built_in">Object</span>.defineProperty( self, <span class="hljs-string">"currentWorkingDirectory"</span>, {
          get: self.getCurrentWorkingDirectory,
          set: self.setCurrentWorkingDirectory,
          configurable: <span class="hljs-literal">true</span>
        } );
        <span class="hljs-comment">/**
         * Current Working Directory stack
         * @property _cwds
         * @private
         * @type {Array}
         */</span>
        self._cwds = [];
        <span class="hljs-comment">/**
         * Push the current working directory on to the stack
         * @method pushCurrentWorkingDirectory
         */</span>
        self.pushCurrentWorkingDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          self._cwds.push( self._cwd );
        };
        <span class="hljs-comment">/**
         * Pop the topmost directory on the stack and change to it
         * @method popCurrentWorkingDirectory
         */</span>
        self.popCurrentWorkingDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          self.setCurrentWorkingDirectory( self._cwds.pop() );
        };
        <span class="hljs-comment">/**
         * Resolves a URL to a local file system. If the URL scheme is not present, `file`
         * is assumed.
         * @param {String} theURI The URI to resolve
         */</span>
        self.resolveLocalFileSystemURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theURI )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _resolveLocalFileSystemURL( theURI ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotEntry</span><span class="hljs-params">( theEntry )</span> </span>{
            deferred.resolve( theEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Returns the file entry for the given path (useful for
         * getting the full path of a file). `options` is of the
         * form `{create: true/false, exclusive: true/false}`
         * @method getFileEntry
         * @param {String} theFilePath The file path or FileEntry object
         * @param {*} options creation options
         */</span>
        self.getFileEntry = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFileEntry</span><span class="hljs-params">( theFileEntry )</span> </span>{
            deferred.resolve( theFileEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Returns the file object for a given file (useful for getting
         * the size of a file); `option` is of the form `{create: true/false, exclusive: true/false}`
         * @method getFile
         * @param {String} theFilePath
         * @param {*} option
         */</span>
        self.getFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options )</span> </span>{
          <span class="hljs-keyword">return</span> self.getFileEntry( theFilePath, options ).then( _getFileObject );
        };
        <span class="hljs-comment">/**
         * Returns the directory entry for a given path
         * @method getDirectoryEntry
         * @param {String} theDirectoryPath
         * @param {*} options
         */</span>
        self.getDirectoryEntry = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theDirectoryPath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, theDirectoryPath, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectoryEntry</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
            deferred.resolve( theDirectoryEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * returns the URL for a given file
         * @method getFileURL
         * @param {String} theFilePath
         * @param {*} options
         */</span>
        self.getFileURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFileEntry</span><span class="hljs-params">( theFileEntry )</span> </span>{
            deferred.resolve( theFileEntry.toURL() );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Returns a URL for the given directory
         * @method getDirectoryURL
         * @param {String} thePath
         * @param {*} options
         */</span>
        self.getDirectoryURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( thePath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, thePath || <span class="hljs-string">"."</span>, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectoryEntry</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
            deferred.resolve( theDirectoryEntry.toURL() );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Returns the native URL for an entry by combining the `fullPath` of the entry
         * with the `nativeURL` of the `root` directory if absolute or of the `current`
         * directory if not absolute.
         * @method getNativeURL
         * @param {String} theEntry Path of the file or directory; can also be a File/DirectoryEntry
         */</span>
        self.getNativeURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theEntry )</span> </span>{
          <span class="hljs-keyword">var</span> thePath = theEntry;
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> theEntry !== <span class="hljs-string">"string"</span> ) {
            thePath = theEntry.fullPath();
          }
          <span class="hljs-keyword">var</span> isAbsolute = ( thePath.substr( <span class="hljs-number">0</span>, <span class="hljs-number">1</span> ) === <span class="hljs-string">"/"</span> ),
            theRootPath = isAbsolute ? self._root.nativeURL : self.cwd.nativeURL;
          <span class="hljs-keyword">return</span> theRootPath + ( isAbsolute ? <span class="hljs-string">""</span> : <span class="hljs-string">"/"</span> ) + thePath;
        };
        <span class="hljs-comment">/**
         * returns the native file path for a given file
         * @method getNativeFileURL
         * @param {String} theFilePath
         * @param {*} options
         */</span>
        self.getNativeFileURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFileEntry</span><span class="hljs-params">( theFileEntry )</span> </span>{
            deferred.resolve( theFileEntry.nativeURL );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Returns a URL for the given directory
         * @method getNativeDirectoryURL
         * @param {String} thePath
         * @param {*} options
         */</span>
        self.getNativeDirectoryURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( thePath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, thePath || <span class="hljs-string">"."</span>, options ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectoryEntry</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
            deferred.resolve( theDirectoryEntry.nativeURL );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Change to an arbitrary directory
         * @method changeDirectory
         * @param  {String} theNewPath The path to the directory, relative to cwd
         * @return {Promise}            The Promise
         */</span>
        self.changeDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theNewPath )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, theNewPath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectory</span><span class="hljs-params">( theNewDirectory )</span> </span>{
            self.cwd = theNewDirectory;
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">()</span> </span>{
            deferred.resolve( self );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Read an arbitrary file's contents.
         * @method readFileContents
         * @param  {String} theFilePath The path to the file, relative to cwd
         * @param  {Object} options     The options to use when opening the file (such as creating it)
         * @param  {String} readAsKind  How to read the file -- best to use self.FILETYPE.TEXT, etc.
         * @return {Promise}             The Promise
         */</span>
        self.readFileContents = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options, readAsKind )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, options || {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheFileEntry</span><span class="hljs-params">( theFileEntry )</span> </span>{
            <span class="hljs-keyword">return</span> _getFileObject( theFileEntry );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheFileObject</span><span class="hljs-params">( theFileObject )</span> </span>{
            <span class="hljs-keyword">return</span> _readFileContents( theFileObject, readAsKind || <span class="hljs-string">"Text"</span> );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTheFileContents</span><span class="hljs-params">( theFileContents )</span> </span>{
            deferred.resolve( theFileContents );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Read an arbitrary directory's entries.
         * @method readDirectoryContents
         * @param  {String} theDirectoryPath The path to the directory, relative to cwd; "." if not specified
         * @param  {Object} options          The options to use when opening the directory (such as creating it)
         * @return {Promise}             The Promise
         */</span>
        self.readDirectoryContents = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theDirectoryPath, options )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, theDirectoryPath || <span class="hljs-string">"."</span>, options || {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheDirectoryEntry</span><span class="hljs-params">(
            theDirectoryEntry )</span> </span>{
            <span class="hljs-keyword">return</span> _readDirectoryContents( theDirectoryEntry );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheDirectoryEntries</span><span class="hljs-params">( theEntries )</span> </span>{
            deferred.resolve( theEntries );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Write data to an arbitrary file
         * @method writeFileContents
         * @param  {String} theFilePath The file name to write to, relative to cwd
         * @param  {Object} options     The options to use when opening the file
         * @param  {*} theData     The data to write
         * @return {Promise}             The Promise
         */</span>
        self.writeFileContents = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath, options, theData )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, options || {
            create: <span class="hljs-literal">true</span>,
            exclusive: <span class="hljs-literal">false</span>
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheFileEntry</span><span class="hljs-params">( theFileEntry )</span> </span>{
            <span class="hljs-keyword">return</span> _createFileWriter( theFileEntry );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheFileWriter</span><span class="hljs-params">( theFileWriter )</span> </span>{
            <span class="hljs-keyword">return</span> _writeFileContents( theFileWriter, theData );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">()</span> </span>{
            deferred.resolve( self );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Creates an arbitrary directory
         * @method createDirectory
         * @param  {String} theDirectoryPath The path, relative to cwd
         * @return {Promise}                  The Promise
         */</span>
        self.createDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theDirectoryPath )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, theDirectoryPath, {
            create: <span class="hljs-literal">true</span>,
            exclusive: <span class="hljs-literal">false</span>
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectory</span><span class="hljs-params">( theNewDirectory )</span> </span>{
            deferred.resolve( theNewDirectory );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Copies a file to a new directory, with an optional new name
         * @method copyFile
         * @param  {String} sourceFilePath      Path to file, relative to cwd
         * @param  {String} targetDirectoryPath Path to new directory, relative to cwd
         * @param  {String} withNewName         New name, if desired
         * @return {Promise}                     The Promise
         */</span>
        self.copyFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceFilePath, targetDirectoryPath, withNewName )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer(),
            theFileToCopy;
          _getFileEntry( self._cwd, sourceFilePath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFileEntry</span><span class="hljs-params">( aFileToCopy )</span> </span>{
            theFileToCopy = aFileToCopy;
            <span class="hljs-keyword">return</span> _getDirectoryEntry( self._cwd, targetDirectoryPath, {} );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectoryEntry</span><span class="hljs-params">( theTargetDirectory )</span> </span>{
            <span class="hljs-keyword">return</span> _copyFile( theFileToCopy, theTargetDirectory, withNewName );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">( theNewFileEntry )</span> </span>{
            deferred.resolve( theNewFileEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Copies a directory to a new directory, with an optional new name
         * @method copyDirectory
         * @param  {String} sourceDirectoryPath Path to directory, relative to cwd
         * @param  {String} targetDirectoryPath Path to new directory, relative to cwd
         * @param  {String} withNewName         New name, if desired
         * @return {Promise}                     The Promise
         */</span>
        self.copyDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceDirectoryPath, targetDirectoryPath, withNewName )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer(),
            theDirectoryToCopy;
          _getDirectoryEntry( self._cwd, sourceDirectoryPath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotSourceDirectoryEntry</span><span class="hljs-params">(
            sourceDirectoryEntry )</span> </span>{
            theDirectoryToCopy = sourceDirectoryEntry;
            <span class="hljs-keyword">return</span> _getDirectoryEntry( self._cwd, targetDirectoryPath, {} );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTargetDirectoryEntry</span><span class="hljs-params">( theTargetDirectory )</span> </span>{
            <span class="hljs-keyword">return</span> _copyDirectory( theDirectoryToCopy, theTargetDirectory, withNewName );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">( theNewDirectoryEntry )</span> </span>{
            deferred.resolve( theNewDirectoryEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * @method moveFile
         * Moves a file to a new directory, with an optional new name
         * @param  {String} sourceFilePath      Path to file, relative to cwd
         * @param  {String} targetDirectoryPath Path to new directory, relative to cwd
         * @param  {String} withNewName         New name, if desired
         * @return {Promise}                     The Promise
         */</span>
        self.moveFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceFilePath, targetDirectoryPath, withNewName )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer(),
            theFileToMove;
          _getFileEntry( self._cwd, sourceFilePath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFileEntry</span><span class="hljs-params">( aFileToMove )</span> </span>{
            theFileToMove = aFileToMove;
            <span class="hljs-keyword">return</span> _getDirectoryEntry( self._cwd, targetDirectoryPath, {} );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDirectoryEntry</span><span class="hljs-params">( theTargetDirectory )</span> </span>{
            <span class="hljs-keyword">return</span> _moveFile( theFileToMove, theTargetDirectory, withNewName );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">( theNewFileEntry )</span> </span>{
            deferred.resolve( theNewFileEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Moves a directory to a new directory, with an optional new name
         * @method moveDirectory
         * @param  {String} sourceDirectoryPath Path to directory, relative to cwd
         * @param  {String} targetDirectoryPath Path to new directory, relative to cwd
         * @param  {String} withNewName         New name, if desired
         * @return {Promise}                     The Promise
         */</span>
        self.moveDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceDirectoryPath, targetDirectoryPath, withNewName )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer(),
            theDirectoryToMove;
          _getDirectoryEntry( self._cwd, sourceDirectoryPath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotSourceDirectoryEntry</span><span class="hljs-params">(
            sourceDirectoryEntry )</span> </span>{
            theDirectoryToMove = sourceDirectoryEntry;
            <span class="hljs-keyword">return</span> _getDirectoryEntry( self._cwd, targetDirectoryPath, {} );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTargetDirectoryEntry</span><span class="hljs-params">( theTargetDirectory )</span> </span>{
            <span class="hljs-keyword">return</span> _moveDirectory( theDirectoryToMove, theTargetDirectory, withNewName );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">( theNewDirectoryEntry )</span> </span>{
            deferred.resolve( theNewDirectoryEntry );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Renames a file to a new name, in the cwd
         * @method renameFile
         * @param  {String} sourceFilePath      Path to file, relative to cwd
         * @param  {String} withNewName         New name
         * @return {Promise}                     The Promise
         */</span>
        self.renameFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceFilePath, withNewName )</span> </span>{
          <span class="hljs-keyword">return</span> self.moveFile( sourceFilePath, <span class="hljs-string">"."</span>, withNewName );
        };
        <span class="hljs-comment">/**
         * Renames a directory to a new name, in the cwd
         * @method renameDirectory
         * @param  {String} sourceDirectoryPath Path to directory, relative to cwd
         * @param  {String} withNewName         New name
         * @return {Promise}                     The Promise
         */</span>
        self.renameDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( sourceDirectoryPath, withNewName )</span> </span>{
          <span class="hljs-keyword">return</span> self.moveDirectory( sourceDirectoryPath, <span class="hljs-string">"."</span>, withNewName );
        };
        <span class="hljs-comment">/**
         * Deletes a file
         * @method deleteFile
         * @param  {String} theFilePath Path to file, relative to cwd
         * @return {Promise}             The Promise
         */</span>
        self.deleteFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theFilePath )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getFileEntry( self._cwd, theFilePath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheFileToDelete</span><span class="hljs-params">( theFileEntry )</span> </span>{
            <span class="hljs-keyword">return</span> _removeFile( theFileEntry );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">()</span> </span>{
            deferred.resolve( self );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Removes a directory, possibly recursively
         * @method removeDirectory
         * @param  {String} theDirectoryPath path to directory, relative to cwd
         * @param  {Boolean} recursively      If true, recursive remove
         * @return {Promise}                  The promise
         */</span>
        self.removeDirectory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( theDirectoryPath, recursively )</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _getDirectoryEntry( self._cwd, theDirectoryPath, {} ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotTheDirectoryToDelete</span><span class="hljs-params">( theDirectoryEntry )</span> </span>{
            <span class="hljs-keyword">return</span> _removeDirectory( theDirectoryEntry, recursively );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">()</span> </span>{
            deferred.resolve( self );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-comment">/**
         * Asks the browser for the requested quota, and then requests the file system
         * and sets the cwd to the root directory.
         * @method _initializeFileSystem
         * @private
         * @return {Promise} The promise
         */</span>
        self._initializeFileSystem = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">var</span> deferred = Q.defer();
          _requestQuota( self.fileSystemType, self.requestedQuota ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotQuota</span><span class="hljs-params">( theQuota )</span> </span>{
            self._actualQuota = theQuota;
            <span class="hljs-keyword">return</span> _requestFileSystem( self.fileSystemType, self.actualQuota );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFS</span><span class="hljs-params">( theFS )</span> </span>{
            self._fileSystem = theFS;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>self._cwd = theFS.root;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> _getDirectoryEntry( theFS.root, <span class="hljs-string">""</span>, {} );
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotRootDirectory</span><span class="hljs-params">( theRootDirectory )</span> </span>{
            self._root = theRootDirectory;
            self._cwd = theRootDirectory;
          } ).then( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allDone</span><span class="hljs-params">()</span> </span>{
            deferred.resolve( self );
          } ).
          <span class="hljs-keyword">catch</span>( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( anError )</span> </span>{
            deferred.reject( anError );
          } ).done();
          <span class="hljs-keyword">return</span> deferred.promise;
        };
        <span class="hljs-keyword">if</span> ( self.overrideSuper ) {
          self.overrideSuper( self.class, <span class="hljs-string">"init"</span>, self.init );
        }
        <span class="hljs-comment">/**
         * Initializes the file manager with the requested file system type (self.PERSISTENT or self.TEMPORARY)
         * and requested quota size. Both must be specified.
         * @method init
         * @param {FileSystem} fileSystemType
         * @param {Number} requestedQuota
         */</span>
        self.init = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( fileSystemType, requestedQuota )</span> </span>{
          <span class="hljs-keyword">if</span> ( self.super ) {
            self.super( _className, <span class="hljs-string">"init"</span> );
          }
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> fileSystemType === <span class="hljs-string">"undefined"</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"No file system type specified; specify PERSISTENT or TEMPORARY."</span> );
          }
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> requestedQuota === <span class="hljs-string">"undefined"</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"No quota requested. If you don't know, specify ZERO."</span> );
          }
          self._requestedQuota = requestedQuota;
          self._fileSystemType = fileSystemType;
          <span class="hljs-keyword">return</span> self._initializeFileSystem(); <span class="hljs-comment">// this returns a promise, so we can .then after.</span>
        };
        <span class="hljs-comment">/**
         * Initializes the file manager with the requested file system type (self.PERSISTENT or self.TEMPORARY)
         * and requested quota size. Both must be specified.
         * @method initWithOptions
         * @param {*} options
         */</span>
        self.initWithOptions = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( options )</span> </span>{
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"undefined"</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"No options specified. Need type and quota."</span> );
          }
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> options.fileSystemType === <span class="hljs-string">"undefined"</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"No file system type specified; specify PERSISTENT or TEMPORARY."</span> );
          }
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> options.requestedQuota === <span class="hljs-string">"undefined"</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">"No quota requested. If you don't know, specify ZERO."</span> );
          }
          <span class="hljs-keyword">return</span> self.init( options.fileSystemType, options.requestedQuota );
        };
        <span class="hljs-keyword">return</span> self;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>meta information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    FileManager.meta = {
      version: <span class="hljs-string">"00.04.450"</span>,
      <span class="hljs-keyword">class</span>: _className,
      autoInitializable: <span class="hljs-literal">false</span>,
      categorizable: <span class="hljs-literal">false</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>assign to <code>window</code> if stand-alone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ( globalContext ) {
      globalContext.FileManager = FileManager;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>return factory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> FileManager;
  } )( Q, BaseObject, ( <span class="hljs-keyword">typeof</span> IN_YASMF !== <span class="hljs-string">"undefined"</span> ) ? <span class="hljs-literal">undefined</span> : <span class="hljs-built_in">window</span> );
} );</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
